/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for all
 * user-specific data and provides public, read-only access to global application
 * data. The primary goal is to completely isolate one user's private data
 * (profiles, searches, offers) from another's, ensuring high security and privacy.
 *
 * Data Structure: The data is segregated into two main categories:
 * 1. User-Private Data: All data specific to a user is nested hierarchically
 *    under the `/users/{userId}` path (e.g., `/users/{userId}/flight_searches/...`).
 *    This path-based ownership is the cornerstone of the security model.
 * 2. Global Public Data: Shared application data like destination recommendations,
 *    airlines, and travel tips are stored in top-level collections. This structural
 *    segregation simplifies rules by allowing for universal read access.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only access documents within their own data tree
 *   (i.e., where the path contains their UID). Cross-user access is strictly forbidden.
 * - Public Data Access: Global collections are readable by anyone, including
 *   unauthenticated users, to support core application functionality before sign-in.
 * - Write Restrictions: All writes to global collections are disabled by default.
 *   This provides a "secure-by-default" posture, assuming that such data is
 *   managed by backend processes or trusted administrators, not client-side users.
 * - No User Listing: It is not possible to list all documents in the top-level
 *   `/users` collection, preventing user enumeration attacks.
 *
 * Denormalization for Authorization: The rules rely on path-based ownership
 * (`/users/{userId}`). For documents within this path, we also enforce that an
 * internal field (e.g., `userId` in `FlightSearch`) matches the path parameter.
 * This ensures data integrity and prevents documents from being misplaced,
 * simplifying rules by avoiding costly `get()` calls to parent documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the primary function for verifying document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner and the document already exists.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates the integrity of a UserProfile on creation.
     * Ensures the document's internal `id` field matches the user's UID.
     */
    function hasValidUserProfileDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates the integrity of a UserProfile on update.
     * Enforces the immutability of the user's `id`.
     */
    function hasValidUserProfileDataOnUpdate() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates the integrity of a FlightSearch on creation.
     * Ensures the document's internal `userId` field matches the owner's UID from the path.
     */
    function hasValidFlightSearchDataOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Validates the integrity of a FlightSearch on update.
     * Enforces the immutability of the `userId` field.
     */
    function hasValidFlightSearchDataOnUpdate() {
      return request.resource.data.userId == resource.data.userId;
    }


    // -------------------------------------------------------------------------
    // User Data Rules (/users)
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document.
     * @deny (get) An authenticated user trying to read another user's profile.
     * @principle Restricts access to a user's own data tree and allows self-creation of a root profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Important: Prevents listing all users.
      allow create: if isOwner(userId) && hasValidUserProfileDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && hasValidUserProfileDataOnUpdate();
      allow delete: if false; // Users should not be able to delete their own root profile document.
    }

    /**
     * @description Secures a user's flight search history.
     * @path /users/{userId}/flight_searches/{flightSearchId}
     * @allow (create) An authenticated user creating a new flight search under their own ID.
     * @deny (list) User 'A' trying to list flight searches belonging to user 'B'.
     * @principle Enforces strict document ownership within a user-specific subcollection.
     */
    match /users/{userId}/flight_searches/{flightSearchId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidFlightSearchDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && hasValidFlightSearchDataOnUpdate();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures flight offers related to a user's specific search.
     * @path /users/{userId}/flight_searches/{flightSearchId}/flight_offers/{flightOfferId}
     * @allow (get) The user who owns the parent search retrieving a flight offer.
     * @deny (create) Any user trying to add a flight offer to another user's search.
     * @principle Inherits ownership from the parent path, ensuring data privacy deep in the hierarchy.
     */
    match /users/{userId}/flight_searches/{flightSearchId}/flight_offers/{flightOfferId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }


    // -------------------------------------------------------------------------
    // Global Data Rules (Public Read-Only)
    // -------------------------------------------------------------------------

    /**
     * @description Provides public read access to destination recommendations.
     * @path /destination_recommendations/{destinationRecommendationId}
     * @allow (get, list) Any user, including unauthenticated ones, reading recommendations.
     * @deny (create, update, delete) Any client attempting to modify the recommendation list.
     * @principle Allows public consumption of shared data while preventing client-side modification.
     */
    match /destination_recommendations/{destinationRecommendationId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Provides public read access to airline information.
     * @path /airlines/{airlineId}
     * @allow (get, list) Any user, including unauthenticated ones, reading airline data.
     * @deny (create, update, delete) Any client attempting to modify the airline data.
     * @principle Allows public consumption of shared data while preventing client-side modification.
     */
    match /airlines/{airlineId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Provides public read access to AI-generated travel tips.
     * @path /travel_tips/{travelTipId}
     * @allow (get, list) Any user, including unauthenticated ones, reading travel tips.
     * @deny (create, update, delete) Any client attempting to modify the travel tips.
     * @principle Allows public consumption of shared data while preventing client-side modification.
     */
    match /travel_tips/{travelTipId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

  }
}